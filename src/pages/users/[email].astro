---
import Layout from "../../layouts/Layout.astro";
import { getUserProfile } from "../../lib/api";
import { User as UserIcon, Calendar, Mail } from "lucide-react";

const { email } = Astro.params;
let user = null;
let error = null;

if (email) {
    const res = await getUserProfile(decodeURIComponent(email));
    if (res.success) {
        user = res.data;
    } else {
        error = res.error;
    }
}

export const prerender = false;
---

<Layout
    title={user ? `${user.displayName || user.email} 的個人資料` : "用戶未找到"}
>
    <div class="container mx-auto max-w-2xl px-4 py-6">
        <div class="mb-6">
            <a
                href="/"
                class="text-blue-600 hover:underline flex items-center gap-1"
            >
                &larr; 返回首頁
            </a>
        </div>

        {
            error && (
                <div
                    class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative"
                    role="alert"
                >
                    <strong class="font-bold">錯誤:</strong>
                    <span class="block sm:inline"> {error}</span>
                </div>
            )
        }

        {
            user && (
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                    <div class="h-32 bg-gradient-to-r from-blue-500 to-cyan-500" />
                    <div class="px-6 pb-6">
                        <div class="relative flex items-end -mt-12 mb-4">
                            <div class="h-24 w-24 rounded-full bg-white p-1">
                                {user.avatar ? (
                                    <img
                                        src={user.avatar}
                                        alt={user.displayName || user.email}
                                        class="h-full w-full rounded-full object-cover"
                                    />
                                ) : (
                                    <div class="h-full w-full rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                        <UserIcon className="h-12 w-12 text-gray-500" />
                                    </div>
                                )}
                            </div>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-900 mb-1">
                            {user.displayName || user.email}
                        </h1>
                        <div class="flex flex-col gap-2 text-gray-600 text-sm mt-4">
                            <div class="flex items-center gap-2">
                                <Mail className="h-4 w-4" />
                                <span>{user.email}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <Calendar className="h-4 w-4" />
                                <span>
                                    加入於{" "}
                                    {new Date(
                                        user.created_at || "",
                                    ).toLocaleDateString()}
                                </span>
                            </div>
                        </div>
                        <div class="mt-6 pt-6 border-t border-gray-100 flex gap-6">
                            <div class="text-center">
                                <div class="text-xl font-bold text-gray-900">
                                    {user.stats?.posts || 0}
                                </div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide">
                                    帖子
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )
        }
    </div>
</Layout>
